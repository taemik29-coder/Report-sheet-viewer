<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>성적 조회/관리 (김태미 프로젝트)</title>
<style>
  :root{--radius:14px}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;margin:0;background:#f7f7fb;color:#222}
  .wrap{max-width:1000px;margin:24px auto;background:#fff;border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.06);padding:18px}
  h1{margin:0 0 8px;font-size:22px}
  .sub{color:#666;margin:0 0 14px}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid #e6e6ee;border-radius:10px;background:#fafafe;cursor:pointer}
  .tab.active{background:#2f67ff;color:#fff;border-color:#2f67ff}
  .box{display:none}
  .box.active{display:block}
  label{font-size:13px;color:#444;display:block;margin:6px 0}
  input,select,button{padding:10px 12px;border:1px solid #e1e1ea;border-radius:10px;background:#fafafe;outline:none}
  input:focus,select:focus{background:#fff;border-color:#bdbdc9}
  button{cursor:pointer;background:#2f67ff;color:#fff;border:none;font-weight:600}
  .grid{display:grid;gap:10px}
  .g2{grid-template-columns:1fr auto}
  .g3{grid-template-columns:1fr 1fr auto}
  .error{background:#fff3f3;color:#b00020;border:1px solid #ffdada;border-radius:10px;padding:10px 12px;margin:8px 0;display:none}
  .ok{background:#eef6ff;color:#114488;border:1px solid #cfe2ff;border-radius:10px;padding:8px 10px;margin:8px 0;display:none}
  .table-wrap{overflow:auto;border:1px solid #eee;border-radius:12px;margin-top:10px}
  table{width:100%;border-collapse:collapse;min-width:620px}
  thead th{position:sticky;top:0;background:#f2f5ff;text-align:left;font-weight:700}
  th,td{border-bottom:1px solid #f0f0f0;padding:10px 12px}
  tfoot td{background:#fafbff;font-weight:600}
  .footer{margin-top:12px;color:#777;font-size:12px;text-align:right}
  .badge{display:inline-block;font-size:12px;background:#eef3ff;color:#2f67ff;border-radius:999px;padding:2px 8px;margin-left:6px}
  .right{justify-self:end}
</style>
</head>
<body>
<div class="wrap">
  <h1>성적 조회/관리 <span class="badge">Google Sheets CSV</span></h1>
  <p class="sub">학번·이름·점수·과목을 구글 시트에서 읽어와 학생/관리자 모드로 보여줍니다. (읽기 전용)</p>

  <div id="err" class="error"></div>
  <div id="ok"  class="ok"></div>

  <div class="tabs">
    <button class="tab active" data-tab="student">학생 전용</button>
    <button class="tab" data-tab="admin">관리자 전용</button>
  </div>

  <!-- 학생 전용 -->
  <div id="student" class="box active">
    <div class="grid g2">
      <div>
        <label for="sid">학번</label>
        <input id="sid" placeholder="예: 20250001" />
      </div>
      <div class="right">
        <label>&nbsp;</label>
        <button id="btnMy">내 성적 보기</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead><tr><th>학번</th><th>이름</th><th>점수</th><th>과목</th></tr></thead>
        <tbody id="tbodyStudent"><tr><td colspan="4">대기 중...</td></tr></tbody>
        <tfoot><tr><td colspan="4" id="sumStudent">총 0건 · 평균 0점</td></tr></tfoot>
      </table>
    </div>
  </div>

  <!-- 관리자 전용 -->
  <div id="admin" class="box">
    <div class="grid g3">
      <div>
        <label for="apw">관리자 비밀번호</label>
        <input id="apw" type="password" placeholder="과제용 임시 비번" />
      </div>
      <div class="right">
        <label>&nbsp;</label>
        <button id="btnLogin">관리자 로그인</button>
      </div>
    </div>

    <div id="panel" style="display:none; margin-top:10px;">
      <div class="grid g3">
        <div>
          <label for="q">검색(학번/이름/과목)</label>
          <input id="q" placeholder="예: 2025 / 홍길동 / 자료구조" />
        </div>
        <div>
          <label for="subj">과목</label>
          <select id="subj"><option value="">(전체)</option></select>
        </div>
        <div class="right">
          <label>&nbsp;</label>
          <button id="btnRefresh">데이터 새로고침</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr><th>학번</th><th>이름</th><th>점수</th><th>과목</th></tr></thead>
          <tbody id="tbodyAdmin"><tr><td colspan="4">관리자 로그인 필요</td></tr></tbody>
          <tfoot><tr><td colspan="4" id="sumAdmin">총 0건 · 평균 0점</td></tr></tfoot>
        </table>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
        <button id="btnExport">현재 화면 CSV로 내보내기</button>
      </div>
    </div>
  </div>

  <div class="footer">© 김태미 프로젝트 전용</div>
</div>

<script>
// ====== 설정 ======
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTg5L5qr_FOmwDLVH9b2TD4OEaloawLcxjlvz96WLPVCec9Vfctm19-MwBBkyG4OoWM85UWzN1auMN2/pub?gid=0&single=true&output=csv";
const ADMIN_PASS = "taemi-admin"; // 관리자 로그인 비밀번호

// ====== 유틸 ======
const $ = s => document.querySelector(s);
const esc = s => String(s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
const showErr = m => { const b=$("#err"); b.textContent=m||""; b.style.display=m?"block":"none"; };
const showOk  = m => { const b=$("#ok");  b.textContent=m||""; b.style.display=m?"block":"none"; };

function parseCSV(text){
  const rows=[]; let row=[],cell="",q=false;
  for(let i=0;i<text.length;i++){
    const ch=text[i],n=text[i+1];
    if(q){ if(ch=='"'&&n=='"'){cell+='"';i++;} else if(ch=='"'){q=false;} else {cell+=ch;} }
    else{ if(ch=='"'){q=true;} else if(ch==','){row.push(cell);cell="";} else if(ch=='\n'){row.push(cell);rows.push(row);row=[];cell="";} else if(ch!='\r'){cell+=ch;} }
  }
  row.push(cell); rows.push(row); return rows;
}

async function fetchRows(){
  const res = await fetch(CSV_URL, {cache:"no-store"});
  if(!res.ok) throw new Error("CSV 응답 오류: "+res.status);
  const txt = await res.text();
  const v = parseCSV(txt);
  if(!v.length) return [];
  const [header, ...data] = v;
  return data.map(r => [r[0]??"", r[1]??"", r[2]??"", r[3]??""]);
}

function averageScore(rows){
  const nums = rows.map(r=>Number(String(r[2]).replace(/[^\d.]/g,""))).filter(n=>!isNaN(n));
  if(!nums.length) return 0;
  return (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(1);
}

function renderRows(tbodyId, sumId, rows){
  const tb = $(tbodyId), sum = $(sumId);
  if(!rows.length){ tb.innerHTML = `<tr><td colspan="4">표시할 데이터가 없습니다.</td></tr>`; sum.textContent=`총 0건 · 평균 0점`; return; }
  tb.innerHTML = rows.map(r=>`<tr><td>${esc(r[0])}</td><td>${esc(r[1])}</td><td>${esc(r[2])}</td><td>${esc(r[3])}</td></tr>`).join("");
  sum.textContent = `총 ${rows.length}건 · 평균 ${averageScore(rows)}점`;
}

// ====== 학생 모드 ======
async function showMyScore(){
  showErr(""); showOk("");
  const id = $("#sid").value.trim();
  if(!id){ showErr("학번을 입력하세요."); renderRows("#tbodyStudent","#sumStudent",[]); return; }
  $("#tbodyStudent").innerHTML = `<tr><td colspan="4">불러오는 중...</td></tr>`;
  try{
    const rows = await fetchRows();
    const mine = rows.filter(r => String(r[0]).trim() === id);
    renderRows("#tbodyStudent","#sumStudent", mine);
  }catch(e){ console.error(e); showErr("데이터를 불러오지 못했습니다. (시트 공개 설정 확인)"); renderRows("#tbodyStudent","#sumStudent",[]); }
}

// ====== 관리자 모드 ======
let cached = [];
let loggedIn = false;

async function adminLogin(){
  showErr(""); showOk("");
  if ($("#apw").value !== ADMIN_PASS){ showErr("비밀번호가 올바르지 않습니다."); return; }
  loggedIn = true;
  $("#panel").style.display = "block";
  await refreshAdmin();
  showOk("관리자 모드로 접속했습니다.");
}

function applyAdminView(){
  let rows = cached.slice();
  const q = $("#q").value.trim().toLowerCase();
  const subj = $("#subj").value;
  if (q){ rows = rows.filter(r => r.some(x => String(x).toLowerCase().includes(q))); }
  if (subj){ rows = rows.filter(r => String(r[3]).trim() === subj); }
  renderRows("#tbodyAdmin","#sumAdmin", rows);
}

async function refreshAdmin(){
  $("#tbodyAdmin").innerHTML = `<tr><td colspan="4">불러오는 중...</td></tr>`;
  try{
    cached = await fetchRows();
    const subjects = Array.from(new Set(cached.map(r => String(r[3]).trim()).filter(Boolean))).sort();
    $("#subj").innerHTML = `<option value="">(전체)</option>` + subjects.map(s=>`<option>${esc(s)}</option>`).join("");
    applyAdminView();
  }catch(e){ console.error(e); showErr("데이터를 불러오지 못했습니다."); renderRows("#tbodyAdmin","#sumAdmin",[]); }
}

function exportCurrentCsv(){
  const rows = [...document.querySelectorAll("#tbodyAdmin tr")].map(tr => [...tr.querySelectorAll("td")].map(td => td.textContent));
  if(!rows.length){ alert("내보낼 데이터가 없습니다."); return; }
  const header = ["학번","이름","점수","과목"];
  const csv = [header, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = "export.csv"; a.click();
  URL.revokeObjectURL(url);
}

// ====== 탭 및 이벤트 ======
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".box").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
  });
});

$("#btnMy").addEventListener("click", showMyScore);
$("#sid").addEventListener("keydown", e=>{ if(e.key==="Enter") showMyScore(); });
$("#btnLogin").addEventListener("click", adminLogin);
$("#btnRefresh").addEventListener("click", refreshAdmin);
$("#q").addEventListener("input", applyAdminView);
$("#subj").addEventListener("change", applyAdminView);
$("#btnExport").addEventListener("click", exportCurrentCsv);
</script>
</body>
</html>
