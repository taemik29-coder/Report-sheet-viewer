<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>성적 조회 | 학생 전용</title>
  <style>
    :root { --radius: 14px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", sans-serif; margin: 0; padding: 24px; background: #f7f7fb; }
    .container { max-width: 720px; margin: 0 auto; background: #fff; padding: 24px; border-radius: var(--radius); box-shadow: 0 8px 32px rgba(0,0,0,0.06); }
    h1 { margin: 0 0 8px; font-size: 22px; }
    .sub { color:#666; margin-bottom: 18px; }
    label { font-size: 13px; color:#444; display:block; margin-bottom: 6px;}
    input, button { width: 100%; padding: 12px; border: 1px solid #e2e2ea; border-radius: 10px; background: #fafafe; outline: none; }
    input:focus { border-color:#bbb; background:#fff;}
    button { cursor:pointer; border:none; background:#2f67ff; color:#fff; font-weight:600; margin-top:8px;}
    .error { background:#fff3f3; color:#b00020; padding:10px 12px; border:1px solid #ffdada; border-radius:10px; margin:12px 0; display:none;}
    .ok { background:#f2f8ff; color:#114488; padding:8px 10px; border:1px solid #cfe2ff; border-radius:10px; margin:12px 0; display:none;}
    table { width:100%; border-collapse: collapse; margin-top: 14px; }
    th, td { border-bottom:1px solid #f0f0f0; padding:12px 10px; text-align:left; }
    thead th { background:#f2f5ff; font-weight:700; }
    .footer { text-align:right; color:#888; margin-top:14px; font-size:12px;}
    .actions { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; }
  </style>
</head>
<body>
  <div class="container">
    <h1>성적 조회 <span style="font-size:12px;background:#eef3ff;color:#2f67ff;border-radius:999px;padding:2px 8px;">학생 전용</span></h1>
    <p class="sub">학번으로 본인 성적·과목만 확인합니다. (읽기 전용 / 김태미 프로젝트)</p>

    <div id="errorBox" class="error" aria-live="assertive"></div>
    <div id="okBox" class="ok"></div>

    <div class="actions">
      <div>
        <label for="studentId">학번</label>
        <input id="studentId" type="text" placeholder="예: 20250001" />
      </div>
      <div>
        <button id="viewBtn" type="button">내 성적 보기</button>
      </div>
    </div>

    <table aria-live="polite">
      <thead>
        <tr><th>학번</th><th>이름</th><th>점수</th><th>과목</th></tr>
      </thead>
      <tbody id="tbody"><tr><td colspan="4">대기 중...</td></tr></tbody>
    </table>

    <div class="footer">© 김태미 프로젝트 전용</div>
  </div>

  <script>
    // ===== 설정 =====
    const SPREADSHEET_ID = "1xzZZpfQpIRt7O94BBAKUjnGVAdNlQihb2v0l7bJSHj0"; // 그대로
    const SHEET_NAME     = "시트1"; // 하단 탭 이름
    // "웹에 게시" 링크를 쓰면 CORS가 더 안정적입니다(선택):
    // const CSV_URL = "https://docs.google.com/spreadsheets/d/....../pub?gid=0&single=true&output=csv";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    const $ = s => document.querySelector(s);
    const error = (m)=>{const b=$("#errorBox"); b.textContent=m||""; b.style.display=m?"block":"none";};
    const ok = (m)=>{const b=$("#okBox"); b.textContent=m||""; b.style.display=m?"block":"none";};

    function parseCSV(text){
      const rows=[]; let row=[],cell="",q=false;
      for(let i=0;i<text.length;i++){const ch=text[i],n=text[i+1];
        if(q){ if(ch=='"'&&n=='"'){cell+='"'; i++;} else if(ch=='"'){q=false;} else {cell+=ch;} }
        else{ if(ch=='"'){q=true;} else if(ch==','){row.push(cell);cell="";} else if(ch=='\n'){row.push(cell);rows.push(row);row=[];cell="";} else if(ch!='\r'){cell+=ch;} }
      }
      row.push(cell); rows.push(row); return rows;
    }

    async function fetchRows(){
      const res = await fetch(CSV_URL,{cache:"no-store"});
      if(!res.ok) throw new Error("CSV 응답 오류: "+res.status);
      const txt = await res.text();
      const v = parseCSV(txt);
      if(!v.length) return [];
      const [header,...data] = v;
      // 열이 3개든 4개든 대응: [학번,이름,점수,과목?]
      return data.map(r=>[r[0]??"", r[1]??"", r[2]??"", r[3]??""]);
    }

    function render(rows){
      const tb = $("#tbody");
      if(!rows.length){ tb.innerHTML = `<tr><td colspan="4">해당 학번 데이터가 없습니다.</td></tr>`; return; }
      tb.innerHTML = rows.map(r=>`<tr><td>${esc(r[0])}</td><td>${esc(r[1])}</td><td>${esc(r[2])}</td><td>${esc(r[3])}</td></tr>`).join("");
    }
    const esc = s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    async function showMyScore() {
      error(""); ok("");
      const id = $("#studentId").value.trim();
      if(!id){ error("학번을 입력하세요."); render([]); return; }
      $("#tbody").innerHTML = `<tr><td colspan="4">불러오는 중...</td></tr>`;
      try{
        const rows = await fetchRows();
        const mine = rows.filter(r => String(r[0]).trim() === id);
        if(mine.length){ ok(`${id} 학생의 성적 ${mine.length}건이 조회되었습니다.`); }
        render(mine);
        // 주소에 ?id=학번 붙여주기(북마크용)
        const url = new URL(location.href); url.searchParams.set("id", id); history.replaceState(null,"",url);
      }catch(e){ console.error(e); error("데이터를 불러오지 못했습니다. (시트 공개/시트명/권한 확인)"); render([]); }
    }

    // 이벤트
    $("#viewBtn").addEventListener("click", showMyScore);
    $("#studentId").addEventListener("keydown", e=>{ if(e.key==="Enter") showMyScore(); });

    // ?id=2025xxxx 지원
    (function initFromQuery(){
      const u = new URL(location.href);
      const id = u.searchParams.get("id");
      if(id){ $("#studentId").value = id; showMyScore(); }
      else { $("#tbody").innerHTML = `<tr><td colspan="4">학번을 입력해 주세요.</td></tr>`; }
    })();
  </script>
</body>
</html>

